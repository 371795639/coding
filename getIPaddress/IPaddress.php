<?php
/**
 * Created by PhpStorm.
 * User: administrator
 * Date: 2018/5/22
 * Time: 上午9:30
 */
/**
 * 获取用户真实 IP
 */
function getIP()
{
    static $realip;
    if (isset($_SERVER)){
        if (isset($_SERVER["HTTP_X_FORWARDED_FOR"])){
            $realip = $_SERVER["HTTP_X_FORWARDED_FOR"];
        } else if (isset($_SERVER["HTTP_CLIENT_IP"])) {
            $realip = $_SERVER["HTTP_CLIENT_IP"];
        } else {
            $realip = $_SERVER["REMOTE_ADDR"];
        }
    } else {
        if (getenv("HTTP_X_FORWARDED_FOR")){
            $realip = getenv("HTTP_X_FORWARDED_FOR");
        } else if (getenv("HTTP_CLIENT_IP")) {
            $realip = getenv("HTTP_CLIENT_IP");
        } else {
            $realip = getenv("REMOTE_ADDR");
        }
    }
    return $realip;
}


/**
 * 获取 IP  地理位置
 * 淘宝IP接口
 * @Return: array
 */
function getRealArea($ip)
{
    $url="http://ip.taobao.com/service/getIpInfo.php?ip=".$ip;
    $ip=json_decode(file_get_contents($url));
    if((string)$ip->code=='1'){
        return false;
    }
    $data = (array)$ip->data;
    return $data;
}

$initialData = '194.228.13.32
94.74.229.90
185.86.96.7
185.86.96.7
185.86.96.7
81.24.108.199
81.24.108.199
77.236.206.219
79.98.72.155
81.24.108.199
213.226.214.61
213.226.214.61
178.21.189.20
178.21.189.20
178.21.189.20
31.31.228.46
31.31.228.46
31.31.228.46
31.31.228.46
213.235.68.93
213.168.177.56
213.235.68.93
94.74.229.90
94.74.229.90
94.74.229.90
84.242.112.187
185.21.163.152
46.135.94.138
46.135.94.138
46.13.35.158
194.228.59.190
194.228.59.190
94.230.146.248
37.221.253.56
94.229.89.37
94.229.89.37
212.211.173.201
109.81.211.53
91.202.46.18
109.81.211.53
37.221.253.56
37.221.253.56
37.221.253.56
109.81.181.189
213.168.181.197
213.168.181.197
213.168.181.197
213.168.181.197
213.168.181.197
86.49.245.240
194.228.32.69
109.81.181.189
109.81.181.189
109.81.181.189
109.81.181.189
37.188.230.249
88.100.36.250
213.168.179.106
62.245.113.149
62.245.113.149
178.255.168.140
90.178.73.68
46.23.50.15
93.190.63.54
37.188.141.56
31.30.61.45
188.175.216.41
194.228.13.32
77.236.206.219
79.98.72.155
213.168.177.56
94.230.146.248
91.202.46.18
86.49.245.240
194.228.32.69
37.188.230.249
88.100.36.250
213.168.179.106
93.190.63.54
37.188.141.56
94.74.229.90
185.86.96.7
185.86.96.7
185.86.96.7
81.24.108.199
81.24.108.199
81.24.108.199
213.226.214.61
213.226.214.61
178.21.189.20
178.21.189.20
178.21.189.20
31.31.228.46
31.31.228.46
31.31.228.46
31.31.228.46
213.235.68.93
213.235.68.93
94.74.229.90
94.74.229.90
94.74.229.90
84.242.112.187
185.21.163.152
46.135.94.138
46.135.94.138
46.13.35.158
194.228.59.190
194.228.59.190
37.221.253.56
94.229.89.37
94.229.89.37
212.211.173.201
109.81.211.53
109.81.211.53
37.221.253.56
37.221.253.56
37.221.253.56
80.188.96.250
213.168.181.197
213.168.181.197
109.81.181.189
213.168.181.197
213.168.181.197
213.168.181.197
109.81.181.189
109.81.181.189
109.81.181.189
109.81.181.189
62.245.113.149
62.245.113.149
178.255.168.140
90.178.73.68
46.23.50.15
31.30.61.45
188.175.216.41
';
// 生成逗号分隔的字符串
$string = preg_replace("/(\n)|(\s)|(\t)|(\')|(')|(，)/" ,',' ,$initialData);
//字符串转化为数组
$arr=explode(',',$string);

foreach ($arr as $item => $value) {

    $ip_info = getRealArea($value);
    $result[$item]['ip'] = $ip_info['ip'];
    $result[$item]['country'] =  $ip_info['country'];
}

$csv_header = ['ip','country'];
// 打开文件资源，不存在则创建
$csv_header = ['ip地址','国家'];
$filename = date("Y-m-d")."-ip.csv";
// 打开文件资源，不存在则创建
$fp = fopen('./csv/'.$filename,'a');
// 处理头部标题
$header = implode(',', $csv_header) . PHP_EOL;
$csv_body = $result;
// 处理内容
$content = '';
foreach ($csv_body as $k => $v) {
    $content .= implode(',', $v) . PHP_EOL;
}
// 拼接
$csv = $header.$content;
// 写入并关闭资源
fwrite($fp, $csv);
fclose($fp);